{% extends "layout.html" %}
{% block content %}
<section class="bento-grid register-grid">
  <div class="bento-card register-guide-card">
    <h3 class="card-title">注册说明</h3>
    <ol class="flow-list">
      <li>使用邮箱注册一个新的 Zepp Life 账号。</li>
      <li>验证码区分大小写，看不清点击图片刷新。</li>
      <li>注册成功后自动跳转到“添加账号”页面，继续完善账号设置。</li>
    </ol>
  </div>

  <div class="bento-card span-2 register-main-card">
    <div class="card-head">
      <h1 class="card-title">注册账号</h1>
    </div>

    <form class="form" id="registerForm">
      <label class="required-label">
        <div>
          <span>邮箱</span>
          <span class="required">*</span>
        </div>
        <input type="email" name="email" id="regEmail" placeholder="example@mail.com" required>
      </label>
      <label class="required-label">
        <div>
          <span>密码</span>
          <span class="required">*</span>
        </div>
        <input type="password" name="password" id="regPassword" required>
      </label>
      <div class="required-label captcha-row">
        <div>
          <span>验证码</span>
          <span class="required">*</span>
        </div>
        <div class="captcha-inputs">
          <input type="text" name="captcha_code" id="regCaptchaCode" class="no-clear" maxlength="6" placeholder="输入验证码" required>
          <img
            class="captcha-img"
            id="captchaImg"
            alt="验证码"
            title="点击刷新验证码"
          >
        </div>
      </div>
      <input type="hidden" name="captcha_key" id="regCaptchaKey" value="">
      <div class="toolbar">
        <button class="button primary" type="submit" id="regSubmit">注册</button>
        <a class="button ghost" href="/">返回</a>
      </div>
    </form>
  </div>

  <div class="bento-card register-empty-card" aria-hidden="true"></div>
</section>

<script>
  (() => {
    const form = document.getElementById("registerForm");
    const captchaImg = document.getElementById("captchaImg");
    const captchaKeyInput = document.getElementById("regCaptchaKey");
    const submitBtn = document.getElementById("regSubmit");

    const loadCaptcha = async () => {
      try {
        const resp = await fetch("/register/captcha", {
          credentials: "same-origin",
          headers: { "X-Requested-With": "XMLHttpRequest" },
        });
        if (!resp.ok) {
          const data = await resp.json().catch(() => ({}));
          throw new Error(data.detail || data.message || `\u83b7\u53d6\u9a8c\u8bc1\u7801\u5931\u8d25\uff08${resp.status}\uff09`);
        }
        const contentType = (resp.headers.get("content-type") || "").toLowerCase();
        if (!contentType.startsWith("image/")) {
          throw new Error("\u83b7\u53d6\u9a8c\u8bc1\u7801\u5931\u8d25\uff1a\u54cd\u5e94\u683c\u5f0f\u5f02\u5e38");
        }
        const key = resp.headers.get("X-Captcha-Key") || "";
        if (!key) {
          throw new Error("\u83b7\u53d6\u9a8c\u8bc1\u7801\u5931\u8d25\uff1a\u9a8c\u8bc1\u7801 key \u7f3a\u5931");
        }
        captchaKeyInput.value = key;
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        captchaImg.onload = () => URL.revokeObjectURL(url);
        captchaImg.src = url;
      } catch (err) {
        captchaKeyInput.value = "";
        captchaImg.removeAttribute("src");
        const message = err instanceof Error ? err.message : "\u83b7\u53d6\u9a8c\u8bc1\u7801\u5931\u8d25";
        window.showMessage?.("error", message || "\u83b7\u53d6\u9a8c\u8bc1\u7801\u5931\u8d25");
      }
    };

    captchaImg?.addEventListener("click", (event) => {
      event.preventDefault();
      loadCaptcha();
    });

    form?.addEventListener("submit", async (event) => {
      event.preventDefault();
      const email = form.querySelector("#regEmail")?.value.trim();
      const password = form.querySelector("#regPassword")?.value.trim();
      const code = form.querySelector("#regCaptchaCode")?.value.trim();
      const key = captchaKeyInput?.value;

      if (!email) {
        window.showMessage?.("error", "请输入邮箱");
        return;
      }
      if (!password) {
        window.showMessage?.("error", "请输入密码");
        return;
      }
      if (password.length < 8) {
        window.showMessage?.("error", "密码长度至少 8 位");
        return;
      }
      if (!/[a-zA-Z]/.test(password) || !/[0-9]/.test(password)) {
        window.showMessage?.("error", "密码必须包含字母和数字");
        return;
      }
      if (!code) {
        window.showMessage?.("error", "请输入验证码");
        return;
      }
      if (!key) {
        window.showMessage?.("error", "验证码未加载，请点击刷新");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "注册中...";
      try {
        const payload = new FormData(form);
        const resp = await fetch("/register", {
          method: "POST",
          credentials: "same-origin",
          body: payload,
          headers: { "X-Requested-With": "XMLHttpRequest" },
        });
        const data = await resp.json().catch(() => ({}));
        if (resp.ok && data.ok) {
          window.showMessage?.("success", "注册成功");
          if (data.session_error) {
            console.warn("session init warning:", data.session_error);
          }
          const target = data.redirect || "/accounts/new";
          window.setTimeout(() => {
            window.location.href = target;
          }, 350);
          return;
        }

        const detail = data.detail || data.message || "注册失败";
        window.showMessage?.("error", detail);
        loadCaptcha();
      } catch (err) {
        window.showMessage?.("error", "网络异常，请稍后重试");
        loadCaptcha();
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "注册";
      }
    });

    loadCaptcha();
  })();
</script>
{% endblock %}
