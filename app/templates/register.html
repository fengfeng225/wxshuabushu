{% extends "layout.html" %}
{% block content %}
<section class="bento-grid register-grid">
  <div class="bento-card register-guide-card">
    <h3 class="card-title">æ³¨å†Œè¯´æ˜</h3>
    <ol class="flow-list">
      <li>ä½¿ç”¨é‚®ç®±æ³¨å†Œä¸€ä¸ªæ–°çš„ Zepp Life è´¦å·ã€‚</li>
      <li>éªŒè¯ç åŒºåˆ†å¤§å°å†™ï¼Œçœ‹ä¸æ¸…ç‚¹å‡»å›¾ç‰‡åˆ·æ–°ã€‚</li>
      <li>æ³¨å†ŒæˆåŠŸåå…ˆå®Œæˆå¾®ä¿¡ç»‘å®šï¼Œå†å»è´¦å·ç®¡ç†ä¸­æ·»åŠ è´¦å·ã€‚</li>
    </ol>
  </div>

  <div class="bento-card span-2 register-main-card">
    <div class="card-head">
      <h1 class="card-title">æ³¨å†Œè´¦å·</h1>
    </div>

    <div id="registerFormView">
      <form class="form" id="registerForm">
        <label class="required-label">
          <div>
            <span>é‚®ç®±</span>
            <span class="required">*</span>
          </div>
          <input type="email" name="email" id="regEmail" placeholder="example@mail.com" required>
        </label>
        <label class="required-label">
          <div>
            <span>å¯†ç </span>
            <span class="required">*</span>
          </div>
          <input type="password" name="password" id="regPassword" required>
        </label>
        <div class="required-label captcha-row">
          <div>
            <span>éªŒè¯ç </span>
            <span class="required">*</span>
          </div>
          <div class="captcha-inputs">
            <input type="text" name="captcha_code" id="regCaptchaCode" class="no-clear" maxlength="6" placeholder="è¾“å…¥éªŒè¯ç " required>
            <img
              class="captcha-img"
              id="captchaImg"
              alt="éªŒè¯ç "
              title="ç‚¹å‡»åˆ·æ–°éªŒè¯ç "
            >
          </div>
        </div>
        <input type="hidden" name="captcha_key" id="regCaptchaKey" value="">
        <div class="toolbar">
          <button class="button primary" type="submit" id="regSubmit">æ³¨å†Œ</button>
          <a class="button ghost" href="/">è¿”å›</a>
        </div>
      </form>
    </div>

    <div class="register-result" id="registerResultView" hidden>
      <p class="register-result-title">æ³¨å†ŒæˆåŠŸ</p>
      <div class="register-result-row">
        <span class="result-label">é‚®ç®±ï¼š</span>
        <span class="result-value" id="registeredEmail">-</span>
      </div>
      <div class="register-result-row">
        <span class="result-label">å¯†ç ï¼š</span>
        <span class="result-value" id="registeredPassword">********</span>
        <button class="eye-toggle" type="button" id="togglePasswordBtn" aria-label="æ˜¾ç¤ºå¯†ç " aria-pressed="false" title="æ˜¾ç¤º/éšè—å¯†ç ">ğŸ‘</button>
      </div>
      <p class="help">è¯·å…ˆå®Œæˆå³ä¾§å¾®ä¿¡ç»‘å®šï¼Œç¡®è®¤åå†åˆ°è´¦å·ç®¡ç†ä¸­æ·»åŠ è´¦å·ã€‚</p>
    </div>
  </div>

  <div class="bento-card register-empty-card" id="registerEmptyCard"></div>

  <div class="bento-card register-weixin-card" id="wxBindCard" hidden>
    <div class="wx-bind-panel" id="wxBindPanel">
      <div class="wx-bind-head">
        <div class="wx-bind-status-row">
          <h3 class="wx-bind-title">å¾®ä¿¡ç»‘å®šçŠ¶æ€</h3>
          <span class="wx-status wx-status-idle" id="wxBindStatusText">å¾…æ£€æµ‹</span>
        </div>
        <button class="button ghost" type="button" id="wxRefreshBtn" disabled>åˆ·æ–°</button>
      </div>
      <p class="help" id="wxBindHint">æ³¨å†ŒæˆåŠŸåå¯åœ¨æ­¤æŸ¥çœ‹å¾®ä¿¡ç»‘å®šçŠ¶æ€ã€‚</p>
      <div class="wx-qr-wrap" id="wxQrWrap" hidden>
        <div class="wx-qr-canvas" id="wxQrCanvas"></div>
      </div>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs2@0.0.2/qrcode.min.js"></script>
<script>
  (() => {
    const form = document.getElementById("registerForm");
    const registerFormView = document.getElementById("registerFormView");
    const registerResultView = document.getElementById("registerResultView");
    const registeredEmail = document.getElementById("registeredEmail");
    const registeredPassword = document.getElementById("registeredPassword");
    const togglePasswordBtn = document.getElementById("togglePasswordBtn");
    const registerEmptyCard = document.getElementById("registerEmptyCard");
    const wxBindCard = document.getElementById("wxBindCard");

    const captchaImg = document.getElementById("captchaImg");
    const captchaKeyInput = document.getElementById("regCaptchaKey");
    const submitBtn = document.getElementById("regSubmit");

    const wxBindPanel = document.getElementById("wxBindPanel");
    const wxBindStatusText = document.getElementById("wxBindStatusText");
    const wxBindHint = document.getElementById("wxBindHint");
    const wxRefreshBtn = document.getElementById("wxRefreshBtn");
    const wxQrWrap = document.getElementById("wxQrWrap");
    const wxQrCanvas = document.getElementById("wxQrCanvas");

    const wxState = {
      accountId: "",
    };

    const accountState = {
      email: "",
      password: "",
      showPlain: false,
    };

    const maskPassword = (value) => {
      const raw = String(value || "");
      return raw ? "*".repeat(raw.length) : "";
    };

    const renderPassword = () => {
      if (!registeredPassword || !togglePasswordBtn) {
        return;
      }
      registeredPassword.textContent = accountState.showPlain ? accountState.password : maskPassword(accountState.password);
      togglePasswordBtn.setAttribute("aria-pressed", String(accountState.showPlain));
      togglePasswordBtn.setAttribute("aria-label", accountState.showPlain ? "éšè—å¯†ç " : "æ˜¾ç¤ºå¯†ç ");
      togglePasswordBtn.textContent = accountState.showPlain ? "ğŸ™ˆ" : "ğŸ‘";
    };

    const showRegisterResult = (email, password) => {
      accountState.email = email || "";
      accountState.password = password || "";
      accountState.showPlain = false;

      if (registeredEmail) {
        registeredEmail.textContent = accountState.email || "-";
      }
      renderPassword();

      if (registerFormView) {
        registerFormView.hidden = true;
      }
      if (registerResultView) {
        registerResultView.hidden = false;
      }
    };

    const setWxStatus = (text, type = "idle") => {
      if (!wxBindStatusText) {
        return;
      }
      wxBindStatusText.textContent = text;
      wxBindStatusText.className = `wx-status wx-status-${type}`;
    };

    const clearWxQr = () => {
      if (wxQrCanvas) {
        wxQrCanvas.innerHTML = "";
      }
      if (wxQrWrap) {
        wxQrWrap.hidden = true;
      }
    };

    const renderWxQr = (url) => {
      if (!url || !wxQrCanvas || !wxQrWrap) {
        clearWxQr();
        return;
      }

      wxQrCanvas.innerHTML = "";

      if (typeof window.QRCode === "function") {
        new window.QRCode(wxQrCanvas, {
          text: url,
          width: 220,
          height: 220,
          correctLevel: window.QRCode.CorrectLevel.M,
        });
      } else {
        const img = document.createElement("img");
        img.alt = "å¾®ä¿¡ç»‘å®šäºŒç»´ç ";
        img.width = 220;
        img.height = 220;
        img.src = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(url)}`;
        wxQrCanvas.appendChild(img);
      }

      wxQrWrap.hidden = false;
    };

    const applyWeixinPayload = (weixin, fromRefresh = false) => {
      if (!wxBindPanel || !wxBindCard || !registerEmptyCard) {
        return;
      }
      if (!weixin) {
        wxBindCard.hidden = true;
        registerEmptyCard.hidden = false;
        wxState.accountId = "";
        clearWxQr();
        return;
      }

      wxBindCard.hidden = false;
      registerEmptyCard.hidden = true;

      wxState.accountId = String(weixin.account_id || wxState.accountId || "");
      wxRefreshBtn.disabled = !wxState.accountId;

      if (!weixin.available) {
        setWxStatus("æ£€æµ‹å¤±è´¥", "error");
        wxBindHint.textContent = weixin.error || "å¾®ä¿¡ç»‘å®šçŠ¶æ€æ£€æµ‹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚";
        clearWxQr();
        return;
      }

      if (weixin.is_bind) {
        setWxStatus("å·²ç»‘å®š", "success");
        wxBindHint.textContent = "å½“å‰è´¦å·å·²ç»‘å®šå¾®ä¿¡ã€‚";
        clearWxQr();
        return;
      }

      setWxStatus("æœªç»‘å®š", "warning");
      if (fromRefresh && weixin.qr_refreshed) {
        wxBindHint.textContent = "ä»æœªç»‘å®šï¼ŒäºŒç»´ç å·²åˆ·æ–°ï¼Œè¯·é‡æ–°æ‰«ç åç‚¹å‡»åˆ·æ–°æ£€æµ‹ã€‚";
      } else {
        wxBindHint.textContent = "è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç ç»‘å®šï¼Œç»‘å®šå®Œæˆåç‚¹å‡»åˆ·æ–°æ£€æµ‹ã€‚";
      }
      renderWxQr(weixin.qr_url);
    };

    const refreshWeixinStatus = async () => {
      if (!wxState.accountId) {
        window.showMessage?.("error", "å½“å‰æ²¡æœ‰å¯åˆ·æ–°çš„ç»‘å®šçŠ¶æ€");
        return;
      }

      const oldText = wxRefreshBtn.textContent;
      wxRefreshBtn.disabled = true;
      wxRefreshBtn.textContent = "åˆ·æ–°ä¸­...";
      try {
        const resp = await fetch("/register/weixin/refresh", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
          body: JSON.stringify({ account_id: wxState.accountId }),
        });
        const data = await resp.json().catch(() => ({}));
        if (resp.ok && data.ok) {
          applyWeixinPayload(data.weixin, true);
          if (!data.weixin?.available) {
            window.showMessage?.("error", data.weixin?.error || "å¾®ä¿¡ç»‘å®šçŠ¶æ€æ£€æµ‹å¤±è´¥");
          } else if (data.weixin?.is_bind) {
            window.showMessage?.("success", "å¾®ä¿¡å·²ç»‘å®š");
          } else {
            window.showMessage?.("warning", "ä»æœªç»‘å®šï¼Œå·²åˆ·æ–°äºŒç»´ç ");
          }
          return;
        }
        window.showMessage?.("error", data.detail || data.message || "åˆ·æ–°å¤±è´¥");
      } catch (err) {
        window.showMessage?.("error", "ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
      } finally {
        wxRefreshBtn.textContent = oldText;
        wxRefreshBtn.disabled = !wxState.accountId;
      }
    };

    const loadCaptcha = async () => {
      try {
        const resp = await fetch("/register/captcha", {
          credentials: "same-origin",
          headers: { "X-Requested-With": "XMLHttpRequest" },
        });
        const key = resp.headers.get("X-Captcha-Key") || "";
        captchaKeyInput.value = key;
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        captchaImg.onload = () => URL.revokeObjectURL(url);
        captchaImg.src = url;
      } catch (err) {
        window.showMessage?.("error", "è·å–éªŒè¯ç å¤±è´¥");
      }
    };

    captchaImg?.addEventListener("click", (event) => {
      event.preventDefault();
      loadCaptcha();
    });

    togglePasswordBtn?.addEventListener("click", () => {
      accountState.showPlain = !accountState.showPlain;
      renderPassword();
    });

    wxRefreshBtn?.addEventListener("click", (event) => {
      event.preventDefault();
      refreshWeixinStatus();
    });

    loadCaptcha();

    form?.addEventListener("submit", async (event) => {
      event.preventDefault();
      const email = form.querySelector("#regEmail")?.value.trim();
      const password = form.querySelector("#regPassword")?.value.trim();
      const code = form.querySelector("#regCaptchaCode")?.value.trim();
      const key = captchaKeyInput?.value;
      if (!email) {
        window.showMessage?.("error", "è¯·è¾“å…¥é‚®ç®±");
        return;
      }
      if (!password) {
        window.showMessage?.("error", "è¯·è¾“å…¥å¯†ç ");
        return;
      }
      if (password.length < 8) {
        window.showMessage?.("error", "å¯†ç é•¿åº¦è‡³å°‘8ä½");
        return;
      }
      if (!/[a-zA-Z]/.test(password) || !/[0-9]/.test(password)) {
        window.showMessage?.("error", "å¯†ç å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—");
        return;
      }
      if (!code) {
        window.showMessage?.("error", "è¯·è¾“å…¥éªŒè¯ç ");
        return;
      }
      if (!key) {
        window.showMessage?.("error", "éªŒè¯ç æœªåŠ è½½ï¼Œè¯·ç‚¹å‡»åˆ·æ–°");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "æ³¨å†Œä¸­...";
      try {
        const payload = new FormData(form);
        const resp = await fetch("/register", {
          method: "POST",
          credentials: "same-origin",
          body: payload,
          headers: { "X-Requested-With": "XMLHttpRequest" },
        });
        const data = await resp.json().catch(() => ({}));
        if (resp.ok && data.ok) {
          window.showMessage?.("success", "æ³¨å†ŒæˆåŠŸ");
          showRegisterResult(email, password);
          wxState.accountId = String(data.account_id || "");
          form.reset();
          loadCaptcha();
          applyWeixinPayload(data.weixin || {
            available: false,
            account_id: wxState.accountId,
            error: "å¾®ä¿¡ç»‘å®šçŠ¶æ€åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·ç‚¹å‡»åˆ·æ–°é‡è¯•",
          }, false);
          if (data.weixin?.available && !data.weixin?.is_bind) {
            window.showMessage?.("warning", "å¾®ä¿¡æœªç»‘å®šï¼Œè¯·æ‰«ç ç»‘å®šåç‚¹å‡»åˆ·æ–°");
          }
          return;
        }

        const detail = data.detail || data.message || "æ³¨å†Œå¤±è´¥";
        window.showMessage?.("error", detail);
        loadCaptcha();
      } catch (err) {
        window.showMessage?.("error", "ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
        loadCaptcha();
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "æ³¨å†Œ";
      }
    });
  })();
</script>
{% endblock %}
