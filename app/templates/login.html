<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ title or "登录" }} - 枫枫步数修改</title>
    <link rel="icon" href="/static/favicon.svg?v={{ static_version }}" type="image/svg+xml" sizes="any">
    <!-- <link rel="icon" href="/static/favicon.png?v={{ static_version }}" type="image/png" sizes="32x32">
    <link rel="shortcut icon" href="/static/favicon.png?v={{ static_version }}" type="image/png"> -->
    <link rel="stylesheet" href="/static/styles.css?v={{ static_version }}">
  </head>
  <body>
    <div class="message-container" id="messageContainer" aria-live="polite"></div>
    <main class="auth-shell">
      <section class="bento-grid">
        <div class="bento-card span-2x2">
          <div class="auth-hero">
            <div class="brand-tag">枫枫步数修改</div>
            <h1 class="card-title">轻量、清爽的步数管理后台</h1>
            <p class="muted">用最少的配置管理多个小米运动账号，执行节奏与记录一目了然。</p>
            <ul class="feature-list">
              <li>多账号集中管理，状态清晰</li>
              <li>定时执行与手动执行结合</li>
              <li>执行记录可追溯，排查省心</li>
              <li>数据本地保存，轻量不折腾</li>
            </ul>
          </div>
        </div>

        <div class="bento-card span-2">
          <div class="card-head">
            <div>
              <h2 class="card-title">管理员登录</h2>
              <p class="card-subtitle">请输入管理员账号与密码。</p>
            </div>
          </div>
          <form method="post" action="/login" class="form" id="loginForm">
            <label class="required-label">
              <div>
                <span>用户名</span>
                <span class="required">*</span>
              </div>
              <input type="text" name="username" autocomplete="username" required>
            </label>
            <label class="required-label">
              <div>
                <span>密码</span>
                <span class="required">*</span>
              </div>
              <input type="password" name="password" autocomplete="current-password" required>
            </label>
            <div class="toolbar">
              <button class="button primary" type="submit">登录</button>
            </div>
          </form>
        </div>

        <div class="bento-card span-2">
          <h3 class="card-title">使用提示</h3>
          <p class="muted">首次登录后请先配置系统设置，再添加账号。</p>
        </div>
      </section>
    </main>
    <script>
      (() => {
        const container = document.getElementById("messageContainer");
        const icons = {
          success: "✓",
          error: "!",
          warning: "!",
          info: "i",
        };

        const showMessage = (type, text, duration = 2200) => {
          if (!container || !text) {
            return;
          }
          const message = document.createElement("div");
          const safeType = icons[type] ? type : "info";
          message.className = `el-message el-message--${safeType}`;
          const icon = document.createElement("span");
          icon.className = "el-message__icon";
          icon.textContent = icons[safeType];
          const content = document.createElement("span");
          content.className = "el-message__content";
          content.textContent = text;
          message.append(icon, content);
          container.appendChild(message);
          requestAnimationFrame(() => message.classList.add("show"));
          window.setTimeout(() => {
            message.classList.remove("show");
            window.setTimeout(() => message.remove(), 200);
          }, duration);
        };

        const form = document.getElementById("loginForm");
        form?.addEventListener("submit", async (event) => {
          event.preventDefault();
          const username = form.querySelector('input[name="username"]');
          const password = form.querySelector('input[name="password"]');
          if (!username?.value.trim() || !password?.value.trim()) {
            showMessage("error", "请输入用户名和密码");
            return;
          }
          const submitBtn = form.querySelector('button[type="submit"]');
          submitBtn && (submitBtn.disabled = true);
          try {
            const payload = new FormData(form);
            const resp = await fetch(form.action, {
              method: "POST",
              body: payload,
              credentials: "same-origin",
              headers: { "X-Requested-With": "XMLHttpRequest" },
            });
            const data = await resp.json().catch(() => ({}));
            if (resp.ok && data.ok) {
              showMessage("success", data.message || "登录成功");
              const target = data.redirect || "/";
              window.setTimeout(() => {
                window.location.href = target;
              }, 600);
            } else {
              const detail = data.detail || data.message || "登录失败";
              showMessage("error", detail);
            }
          } catch (err) {
            showMessage("error", "网络异常，请稍后重试");
          } finally {
            if (submitBtn) {
              submitBtn.disabled = false;
            }
          }
        });
      })();
    </script>
    <script>
      (() => {
        window.addEventListener("pageshow", (event) => {
          if (event.persisted) {
            window.location.reload();
          }
        });
      })();
    </script>
  </body>
</html>
