{% extends "layout.html" %}
{% block content %}
<section class="bento-grid">
  <div class="bento-card span-3 overview-card">
    <div class="card-head">
      <h3 class="card-title">执行概览</h3>
    </div>
    <div class="overview-stats">
      <div class="stat-item success">
        <div class="stat-label">累计成功</div>
        <div class="stat-number">{{ success_total }}</div>
      </div>
      <div class="stat-item danger">
        <div class="stat-label">累计失败</div>
        <div class="stat-number">{{ fail_total }}</div>
      </div>
      <div class="stat-item primary">
        <div class="stat-label">最近一次执行</div>
        <div class="stat-number">{{ last_run_at }}</div>
      </div>
    </div>
    <div class="today-activity">
      <div class="today-activity-head">
        <div class="today-title-group">
          <div class="today-title">今日执行</div>
          <div class="activity-legend">
            <span class="legend-item"><i class="activity-dot success"></i>成功</span>
            <span class="legend-item"><i class="activity-dot fail"></i>失败</span>
            <span class="legend-item"><i class="activity-dot pending"></i>进行中</span>
          </div>
        </div>
        <div class="today-meta">{{ today_success_rate }} 成功率 · {{ today_total }} 次</div>
      </div>
      <div class="activity-bar" role="img" aria-label="今日执行情况">
        {% if today_timeline|length > 0 %}
          {% for item in today_timeline %}
          <span
            class="activity-dot {{ item.status }}"
            title="{{ item.started_at }} · {{ item.account }} · {{ item.status_label }}"
          ></span>
          {% endfor %}
        {% else %}
          <span class="muted">今日暂无执行</span>
        {% endif %}
      </div>
      <div class="activity-scale">
        <span>00:00</span>
        <span>12:00</span>
        <span>现在</span>
      </div>
    </div>
  </div>

  <div class="bento-card compact-card">
    <h3 class="card-title">查看详情</h3>
    <p class="muted">点击表格右侧“查看”进入详情。</p>
    <div class="compact-tip">
      <span class="tip-icon">↗</span>
      <span>包含日志输出与错误码</span>
    </div>
  </div>

  <div class="bento-card span-4">
    <div class="card-head">
      <div>
        <h1 class="card-title">执行记录</h1>
        <p class="card-subtitle">最近执行任务与结果。</p>
      </div>
    </div>
    <div class="table-wrap">
      <table class="center-table">
        <thead>
          <tr>
            <th>序号</th>
            <th>账号</th>
            <th>步数</th>
            <th>执行方式</th>
            <th>状态</th>
            <th>开始时间</th>
            <th>结束时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for run in runs %}
          <tr>
            <td>{{ (page - 1) * per_page + loop.index }}</td>
            <td>{{ run.account_label }}</td>
            <td>{{ run.step_label }}</td>
            <td>{{ run.trigger_label }}</td>
            <td>
              {% if run.exit_code is none %}
              -
              {% elif run.exit_code == 0 %}
              <span class="tag success">成功</span>
              {% else %}
              <span class="tag fail">失败</span>
              {% endif %}
            </td>
            <td>{{ run.started_at_fmt }}</td>
            <td>{{ run.finished_at_fmt }}</td>
            <td>
              <a class="text-link" href="/logs/{{ run.id }}">查看</a>
            </td>
          </tr>
          {% endfor %}
          {% if runs|length == 0 %}
          <tr>
            <td colspan="8" class="muted">暂无执行记录</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    <div class="pagination-bar">
      <div class="pagination-left">
        <span class="pagination-total">共 {{ total }} 条</span>
        <label class="page-size">
          <select data-role="per-page">
            {% for size in [10, 20, 50, 100] %}
              {% if size == per_page %}
              <option value="{{ size }}" selected>{{ size }} 条/页</option>
              {% else %}
              <option value="{{ size }}">{{ size }} 条/页</option>
              {% endif %}
            {% endfor %}
          </select>
        </label>
      </div>
      <div class="pager">
        {% if page > 1 %}
        <a class="page" href="/logs?page={{ page - 1 }}&per_page={{ per_page }}">上一页</a>
        {% else %}
        <span class="page disabled">上一页</span>
        {% endif %}
        {% for p in page_numbers %}
          {% if p == page %}
          <span class="page current">{{ p }}</span>
          {% else %}
          <a class="page" href="/logs?page={{ p }}&per_page={{ per_page }}">{{ p }}</a>
          {% endif %}
        {% endfor %}
        {% if page < total_pages %}
        <a class="page" href="/logs?page={{ page + 1 }}&per_page={{ per_page }}">下一页</a>
        {% else %}
        <span class="page disabled">下一页</span>
        {% endif %}
      </div>
      <div class="pagination-right">
        <label class="page-jumper">
          <span>前往</span>
          <input type="number" min="1" max="{{ total_pages }}" value="{{ page }}" data-role="page-jump">
          <span>页</span>
          <button class="button ghost page-jump-btn" type="button" data-role="page-jump-btn">确定</button>
        </label>
      </div>
    </div>
  </div>
</section>
<script>
  (() => {
    const perPageSelect = document.querySelector('[data-role="per-page"]');
    if (perPageSelect) {
      perPageSelect.addEventListener("change", () => {
        const params = new URLSearchParams(window.location.search);
        params.set("per_page", perPageSelect.value);
        params.set("page", "1");
        window.location.search = params.toString();
      });
    }
    const jumpInput = document.querySelector('[data-role="page-jump"]');
    const jumpBtn = document.querySelector('[data-role="page-jump-btn"]');
    const jump = () => {
      if (!jumpInput) {
        return;
      }
      const max = parseInt(jumpInput.max || "1", 10);
      let val = parseInt(jumpInput.value || "1", 10);
      if (Number.isNaN(val)) {
        return;
      }
      if (val < 1) {
        val = 1;
      }
      if (val > max) {
        val = max;
      }
      const params = new URLSearchParams(window.location.search);
      params.set("page", String(val));
      window.location.search = params.toString();
    };
    if (jumpInput) {
      jumpInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          jump();
        }
      });
    }
    if (jumpBtn) {
      jumpBtn.addEventListener("click", jump);
    }
  })();
</script>
{% endblock %}
